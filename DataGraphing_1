%% Processing Code for the Inverse Kinematics and Inverse Dynamics from Opensim
% Also Includes Filtering.  We only Filter Inverse Kinematics
% Carlo Code, Henry Edit 
% Modified 09/15/2025

clear all
close all
clc;
tic;

Font_Size = 12;
syms H M L

% Directory Name Change per Subject
% Directory_Location = 'C:\Users\Henry\Downloads\VIPSTUFF';
% change directory location for my computer here
% procesed data reading needs to be dynamically sized, inside loop
%Double %% brings to location
% For psuedocode, create this break to easily navigate 
% Idea is to create 1 giant struct for EACH subject
% example name: H4M6L12
% each field will have a file associated with it, follow same naming
% convention
% Goal for first week, be able to call the files in each struct e
% focus reading loop for this week 
% 1 struct instead of 9 tables, be able to call structres for data access

Weight_Range = [H, M, L]
Location_Range = [4, 6, 12];
subjectNumber = 02;     
%% Reading loop
subjectStruct = struct()
for i = 1:length(Weight_Range)
       Weight = Weight_Range(i)
       for j = 1:length(Location_Range)
       Location = Location_Range(j)
       fidProcessed = strcat('Processed_',num2str(subjectNumber,'%02d'),'_', char(Weight), '_', num2str(Location)) % file ID, concatenating name, processed data
       completedRead = readtable(fidProcessed);
       subjectStruct.(fidProcessed) = completedRead;
       end
end

%need to save struct as file after creating, docmat
% write table, write something, look up - call file "subject 1" 
% drop loop in biomedical team chat
% october second, biomechancis data post processing 
%g = subjectStruct.('Processed_01_M_4')

% 
% H_4 = readtable("Processed_01_H_4.csv");
% M_4 = readtable("Processed_01_M_4.csv");
% L_4 = readtable("Processed_01_L_4.csv");
% 
% H_6 = readtable("Processed_01_H_6.csv");
% M_6 = readtable("Processed_01_M_6.csv");
% L_6 = readtable("Processed_01_L_6.csv");
% 
% H_12 = readtable("Processed_01_H_12.csv");
% M_12 = readtable("Processed_01_M_12.csv");
% L_12 = readtable("Processed_01_L_12.csv");

% goal end of loop above
Pos_Work_ShoulderElevationR = [];
Neg_Work_ShoulderElevationR = [];
Net_Work_ShoulderElevationR = [];

Pos_Impulse_ShoulderElevationR = [];
Neg_Impulse_ShoulderElevationR = [];
Net_Impulse_ShoulderElevationR = [];            

Pos_Work_ElbowFlexionR = [];
Neg_Work_ElbowFlexionR = [];
Net_Work_ElbowFlexionR = [];

Pos_Impulse_ElbowFlexionR = [];
Neg_Impulse_ElbowFlexionR = [];
Net_Impulse_ElbowFlexionR = [];

Weight_Range = [L, M, H];
Location_Range = [4, 6, 12];

% create new struct with fields 
% processing loop, 

WorkPowerStruct = struct();
for i = 1:length(Weight_Range)
       Weight = Weight_Range(i)
       for j = 1:length(Location_Range)
           Location = Location_Range(j)
           fidProcessed = strcat('Processed_',num2str(subjectNumber,'%02d'),'_', char(Weight), '_', num2str(Location))
        
           if isfield(subjectStruct,fidProcessed)          % Checking if file exists      
                table = subjectStruct.(fidProcessed);          % Loads data from file
                Time = table.ShiftedTime_Array;
                
                % Shoulder Elevation
                JointPower_ShoulderElevationR = (table.JointPower_ShoulderElevationR)*(pi()/180);
                JointMoment_ShoulderElevationR = table.shoulder_elv_r_moment;

                Net_JointImpulse_ShoulderElevationR = trapz(Time,JointMoment_ShoulderElevationR); % Net Impulse
                Net_JointWork_ShoulderElevationR = trapz(Time,JointPower_ShoulderElevationR); % Net Work

                Positive_JointMoment_ShoulderElevationR = JointMoment_ShoulderElevationR(JointMoment_ShoulderElevationR>0);
                Positive_JointImpulse_ShoulderElevationR = trapz(Time(1:length(Positive_JointMoment_ShoulderElevationR)),Positive_JointMoment_ShoulderElevationR);
                
                Negative_JointMoment_ShoulderElevationR = JointMoment_ShoulderElevationR(JointMoment_ShoulderElevationR<0);
                Negative_JointImpulse_ShoulderElevationR = trapz(Time(1:length(Negative_JointMoment_ShoulderElevationR)),Negative_JointMoment_ShoulderElevationR);

                Positive_JointPower_ShoulderElevationR = JointPower_ShoulderElevationR(JointPower_ShoulderElevationR>0);
                Positive_JointWork_ShoulderElevationR = trapz(Time(1:length(Positive_JointPower_ShoulderElevationR)),Positive_JointPower_ShoulderElevationR);
                
                Negative_JointPower_ShoulderElevationR = JointPower_ShoulderElevationR(JointPower_ShoulderElevationR<0);
                Negative_JointWork_ShoulderElevationR = trapz(Time(1:length(Negative_JointPower_ShoulderElevationR)),Negative_JointPower_ShoulderElevationR);

                WorkPowerStruct.(fidProcessed).Pos_Work_ShoulderElevationR = [Pos_Work_ShoulderElevationR Positive_JointWork_ShoulderElevationR];
                WorkPowerStruct.(fidProcessed).Neg_Work_ShoulderElevationR = [Neg_Work_ShoulderElevationR Negative_JointWork_ShoulderElevationR];
                WorkPowerStruct.(fidProcessed).Net_Work_ShoulderElevationR = [Net_Work_ShoulderElevationR Net_JointWork_ShoulderElevationR];

                WorkPowerStruct.(fidProcessed).Pos_Impulse_ShoulderElevationR = [Pos_Impulse_ShoulderElevationR Positive_JointImpulse_ShoulderElevationR];
                WorkPowerStruct.(fidProcessed).Neg_Impulse_ShoulderElevationR = [Neg_Impulse_ShoulderElevationR Negative_JointImpulse_ShoulderElevationR];
                WorkPowerStruct.(fidProcessed).Net_Impulse_ShoulderElevationR = [Net_Impulse_ShoulderElevationR Net_JointImpulse_ShoulderElevationR];

                % Elbow
                JointPower_ElbowFlexionR = (table.JointPower_ElbowFlexionR)*(pi()/180);
                JointMoment_ElbowFlexionR = table.elbow_flexion_r_moment;

                Net_JointImpulse_ElbowFlexionR = trapz(Time,JointMoment_ElbowFlexionR); % Net Impulse
                Net_JointWork_ElbowFlexionR = trapz(Time,JointPower_ElbowFlexionR); % Net Work

                Positive_JointMoment_ElbowFlexionR = JointMoment_ElbowFlexionR(JointMoment_ElbowFlexionR>0);
                Positive_JointImpulse_ElbowFlexionR = trapz(Time(1:length(Positive_JointMoment_ElbowFlexionR)),Positive_JointMoment_ElbowFlexionR);
                
                Negative_JointMoment_ElbowFlexionR = JointMoment_ElbowFlexionR(JointMoment_ElbowFlexionR<0);
                Negative_JointImpulse_ElbowFlexionR = trapz(Time(1:length(Negative_JointMoment_ElbowFlexionR)),Negative_JointMoment_ElbowFlexionR);

                Positive_JointPower_ElbowFlexionR = JointPower_ElbowFlexionR(JointPower_ElbowFlexionR>0);
                Positive_JointWork_ElbowFlexionR = trapz(Time(1:length(Positive_JointPower_ElbowFlexionR)),Positive_JointPower_ElbowFlexionR);
                
                Negative_JointPower_ElbowFlexionR = JointPower_ElbowFlexionR(JointPower_ElbowFlexionR<0);
                Negative_JointWork_ElbowFlexionR = trapz(Time(1:length(Negative_JointPower_ElbowFlexionR)),Negative_JointPower_ElbowFlexionR);

                WorkPowerStruct.(fidProcessed).Pos_Work_ElbowFlexionR = [Pos_Work_ElbowFlexionR Positive_JointWork_ElbowFlexionR];
                WorkPowerStruct.(fidProcessed).Neg_Work_ElbowFlexionR = [Neg_Work_ElbowFlexionR Negative_JointWork_ElbowFlexionR];
                WorkPowerStruct.(fidProcessed).Net_Work_ElbowFlexionR = [Net_Work_ElbowFlexionR Net_JointWork_ElbowFlexionR];

                WorkPowerStruct.(fidProcessed).Pos_Impulse_ElbowFlexionR = [Pos_Impulse_ElbowFlexionR Positive_JointImpulse_ElbowFlexionR];
                WorkPowerStruct.(fidProcessed).Neg_Impulse_ElbowFlexionR = [Neg_Impulse_ElbowFlexionR Negative_JointImpulse_ElbowFlexionR];
                WorkPowerStruct.(fidProcessed).Net_Impulse_ElbowFlexionR = [Net_Impulse_ElbowFlexionR Net_JointImpulse_ElbowFlexionR];                
           end
       end
end

% possible to combine workpower struct and subject struct?
% want to output file - do .mat file, save overall struct
% this saves the output 
% create names for mat file
% save workpowerstruct and subject structure with correct name
% 
save('workpowerstruct.mat', 'WorkPowerStruct');

Directory_Location = 'C:\Users\Henry\Downloads\VIPSTUFF';
% Printing graphs, saving into folders, subject 1 goes to subject 1 folder,
% Saving png svg, put all in folder 
% include power, should be one extra graph 
% edit limits on graphs 
% make flowchart for presentation, get data, print graphs, one button
% press, multiple subjects for one button press, 
% gimbal locking stuff
% Create Folders for each subject, only print within folder (not directory) 
JointAngValS = strcat('Joint_Angle_Values_Shoulder_',num2str(subjectNumber,'%02d')); 
JointAngValE = strcat('Joint_Angle_Values_Elbow_', num2str(subjectNumber,'%02d'))
JointVelValE = strcat('Joint_Velocity_Values_Elbow_', num2str(subjectNumber,'%02d'));
JointMomValS = strcat('Joint_Moment_Values_Shoulder_', num2str(subjectNumber,'%02d'));
JointMomValE = strcat('Joint_Moment_Values_Elbow_', num2str(subjectNumber,'%02d'));
JointPowValS = strcat('Joint_Power_Values_Shoulder_', num2str(subjectNumber,'%02d'));
JointPowValE = strcat('Joint_Power_Values_Elbow_', num2str(subjectNumber,'%02d'));


mkdir(Directory_Location,JointAngValS);
mkdir(Directory_Location,JointAngValE);
mkdir(Directory_Location,JointVelValE);
mkdir(Directory_Location,JointMomValS);
mkdir(Directory_Location,JointMomValE);
mkdir(Directory_Location,JointPowValS);
mkdir(Directory_Location,JointPowValE);

Locations = [4, 6, 12];
Weights = [L, M, H]
for i = 1:length(Locations)
    Location = Locations(i);
    figure('Name', sprintf("Joint Angle Values %d Shoulder", Location));
    hold on
    grid on;
    for j = 1:length(Weights)
        Weight = Weights(j);
         switch char(Weight)
            case 'H', legText = '$High_{3.75\ kg}$';
            case 'M', legText = '$Medium_{1.82\ kg}$';
            case 'L', legText = '$Low_{0.2\ kg}$';
            otherwise, legText = char(Weight);
         end
        fid = strcat('Processed_',num2str(subjectNumber,'%02d'),'_', char(Weight), '_', num2str(Location)) % file ID, concatenating name, processed data
        fidTime = subjectStruct.(fid){2:701,1}
        fidp = subjectStruct.(fid){2:701,2}
        plot(fidTime, fidp,'LineWidth',3, 'DisplayName', legText);
        xlabel('time (s)','Interpreter','LaTex','FontSize',Font_Size);
        ylabel('Joint Angle (Deg)','Interpreter','LaTex','FontSize',Font_Size);
        ylim([0 120])
        lh = legend('Location','best', 'Interpreter','LaTeX', 'FontSize', Font_Size);
        print(fullfile(JointAngValS, sprintf('JointAngleLocation%d_Shoulder', Location)), '-dpng');
        print(fullfile(JointAngValS, sprintf('JointAngleLocation%d_Shoulder', Location)), '-dsvg')
    end
   
    hold off;
    figure('Name', sprintf("Joint Angle Values %d Elbow", Location));
    hold on
    grid on;
    for j = 1:length(Weights)
        Weight = Weights(j);
        switch char(Weight)
            case 'H', legText = '$High_{3.75\ kg}$';
            case 'M', legText = '$Medium_{1.82\ kg}$';
            case 'L', legText = '$Low_{0.2\ kg}$';
            otherwise, legText = char(Weight);
        end
        fid = strcat('Processed_',num2str(subjectNumber,'%02d'),'_', char(Weight), '_', num2str(Location)) % file ID, concatenating name, processed data
        fidTime = subjectStruct.(fid){2:701,1}
        fidp = subjectStruct.(fid){2:701,6}
        plot(fidTime, fidp,'LineWidth',3, 'DisplayName', legText);
        xlabel('time (s)','Interpreter','LaTex','FontSize',Font_Size);
        ylabel('Joint Angle (Deg)','Interpreter','LaTex','FontSize',Font_Size);
        ylim([0 120])
        lh = legend('Location','best', 'Interpreter','LaTeX', 'FontSize', Font_Size);
        print(fullfile(JointAngValE, sprintf('JointAngleLocation%d_Elbow', Location)), '-dpng');
        print(fullfile(JointAngValE, sprintf('JointAngleLocation%d_Elbow', Location)), '-dsvg')
    end

    hold off;
    figure('Name', sprintf("Joint Velocity Values %d Elbow", Location));
    hold on
    grid on;
    for j = 1:length(Weights)
        Weight = Weights(j);
        switch char(Weight)
            case 'H', legText = '$High_{3.75\ kg}$';
            case 'M', legText = '$Medium_{1.82\ kg}$';
            case 'L', legText = '$Low_{0.2\ kg}$';
            otherwise, legText = char(Weight);
        end
        fid = strcat('Processed_',num2str(subjectNumber,'%02d'),'_', char(Weight), '_', num2str(Location)) % file ID, concatenating name, processed data
        fidTime = subjectStruct.(fid){2:701,1}
        fidp = subjectStruct.(fid){2:701,7}
        plot(fidTime, fidp,'LineWidth',3, 'DisplayName', legText);
        xlabel('time (s)','Interpreter','LaTex','FontSize',Font_Size);
        ylabel('Joint Velocity (Deg/sec)','Interpreter','LaTex','FontSize',Font_Size);
        ylim([-5 45])
        lh = legend('Location','best', 'Interpreter','LaTeX', 'FontSize', Font_Size);
        print(fullfile(JointVelValE, sprintf('JointVelocityLocation%d_Elbow', Location)), '-dpng');
        print(fullfile(JointVelValE, sprintf('JointVelocityLocation%d_Elbow', Location)), '-dsvg')
    end

    hold off;
    figure('Name', sprintf("Joint Moment Values %d Shoulder", Location));
    hold on
    grid on;
    for j = 1:length(Weights)
        Weight = Weights(j);
        switch char(Weight)
            case 'H', legText = '$High_{3.75\ kg}$';
            case 'M', legText = '$Medium_{1.82\ kg}$';
            case 'L', legText = '$Low_{0.2\ kg}$';
            otherwise, legText = char(Weight);
        end
        fid = strcat('Processed_',num2str(subjectNumber,'%02d'),'_', char(Weight), '_', num2str(Location)) % file ID, concatenating name, processed data
        fidTime = subjectStruct.(fid){2:701,1}
        fidp = subjectStruct.(fid){2:701,4}
        plot(fidTime, fidp,'LineWidth',3, 'DisplayName', legText);
        xlabel('time (s)','Interpreter','LaTex','FontSize',Font_Size);
        ylabel('Joint Moment (N-m)','Interpreter','LaTex','FontSize',Font_Size);
        ylim([-5 45])
        lh = legend('Location','best', 'Interpreter','LaTeX', 'FontSize', Font_Size);
        print(fullfile(JointMomValS, sprintf('JointMomentLocation%d_Shoulder', Location)), '-dpng');
        print(fullfile(JointMomValS, sprintf('JointMomentLocation%d_Shoulder', Location)), '-dsvg')
    end

    hold off;
    figure('Name', sprintf("Joint Moment Values %d Elbow", Location));
    hold on
    grid on;
    for j = 1:length(Weights)
        Weight = Weights(j);
        switch char(Weight)
            case 'H', legText = '$High_{3.75\ kg}$';
            case 'M', legText = '$Medium_{1.82\ kg}$';
            case 'L', legText = '$Low_{0.2\ kg}$';
            otherwise, legText = char(Weight);
        end
        fid = strcat('Processed_',num2str(subjectNumber,'%02d'),'_', char(Weight), '_', num2str(Location)) % file ID, concatenating name, processed data
        fidTime = subjectStruct.(fid){2:701,1}
        fidp = subjectStruct.(fid){2:701,8}
        plot(fidTime, fidp,'LineWidth',3, 'DisplayName', legText);
        xlabel('time (s)','Interpreter','LaTex','FontSize',Font_Size);
        ylabel('Joint Moment (N-m)','Interpreter','LaTex','FontSize',Font_Size);
        ylim([-5 45])
        lh = legend('Location','best', 'Interpreter','LaTeX', 'FontSize', Font_Size);
        print(fullfile(JointMomValE, sprintf('JointMomentLocation%d_Elbow', Location)), '-dpng');
        print(fullfile(JointMomValE, sprintf('JointMomentLocation%d_Elbow', Location)), '-dsvg')
    end

    hold off;
    figure('Name', sprintf("Joint Power Values %d Shoulder", Location));
    hold on
    grid on;
    for j = 1:length(Weights)
        Weight = Weights(j);
        switch char(Weight)
            case 'H', legText = '$High_{3.75\ kg}$';
            case 'M', legText = '$Medium_{1.82\ kg}$';
            case 'L', legText = '$Low_{0.2\ kg}$';
            otherwise, legText = char(Weight);
        end
        fid = strcat('Processed_',num2str(subjectNumber,'%02d'),'_', char(Weight), '_', num2str(Location)) % file ID, concatenating name, processed data
        fidTime = subjectStruct.(fid){2:701,1};
        fidp = subjectStruct.(fid){2:701,5};
        plot(fidTime, fidp*(pi()/180),'LineWidth',3, 'DisplayName', legText);
        xlabel('time (s)','Interpreter','LaTex','FontSize',Font_Size);
        ylabel('Joint Power (W)','Interpreter','LaTex','FontSize',Font_Size);
        ylim([-80 100])
        lh = legend('Location','best', 'Interpreter','LaTeX', 'FontSize', Font_Size);
        print(fullfile(JointPowValS, sprintf('JointPowerLocation%d_Shoulder', Location)), '-dpng');
        print(fullfile(JointPowValS, sprintf('JointPowerLocation%d_Shoulder', Location)), '-dsvg')
    end

    hold off;
    figure('Name', sprintf("Joint Power Values %d Elbow", Location));
    hold on
    grid on;
    for j = 1:length(Weights)
        Weight = Weights(j);
        switch char(Weight)
            case 'H', legText = '$High_{3.75\ kg}$';
            case 'M', legText = '$Medium_{1.82\ kg}$';
            case 'L', legText = '$Low_{0.2\ kg}$';
            otherwise, legText = char(Weight);
        end
        fid = strcat('Processed_',num2str(subjectNumber,'%02d'),'_', char(Weight), '_', num2str(Location)) % file ID, concatenating name, processed data
        fidTime = subjectStruct.(fid){2:701,1};
        fidp = subjectStruct.(fid){2:701,9};
        plot(fidTime, fidp*(pi()/180),'LineWidth',3, 'DisplayName', legText);
        xlabel('time (s)','Interpreter','LaTex','FontSize',Font_Size);
        ylabel('Joint Power (W)','Interpreter','LaTex','FontSize',Font_Size);
        ylim([-80 100])
        lh = legend('Location','best', 'Interpreter','LaTeX', 'FontSize', Font_Size);
        print(fullfile(JointPowValE, sprintf('JointPowerLocation%d_Elbow', Location)), '-dpng');
        print(fullfile(JointPowValE, sprintf('JointPowerLocation%d_Elbow', Location)), '-dsvg')
    end
end


